var Ie=Object.defineProperty;var De=(h,t,f)=>t in h?Ie(h,t,{enumerable:!0,configurable:!0,writable:!0,value:f}):h[t]=f;var G=(h,t,f)=>(De(h,typeof t!="symbol"?t+"":t,f),f);import{d as re,r as M,o as ce,W as r,a as ie,b as x,c as y,F,e as ue,n as we,f as Q,t as k,g as n,u as X,C as B,h as A,i as he,j as Te,k as P,l as U,A as b,m as Le,S as ke,p as ne,w as se,v as ae,q as $e,s as be,T as Ee,M as O,x as oe,y as qe,z as j,B as Ne,D as Re,E as z,G as Ae,H as Ue,I as He,P as le,J,K as Fe}from"./index-e52186d6.js";import{_ as de}from"./_plugin-vue_export-helper-c27b6911.js";class Y{constructor(t){G(this,"conversation");G(this,"avatarHashTag");this.conversation=t}get channel(){return this.conversation.channel}get channelInfo(){return this.conversation.channelInfo}get unread(){return this.conversation.unread}get timestamp(){return this.conversation.timestamp}set timestamp(t){this.conversation.timestamp=t}get timestampString(){return Be(this.timestamp*1e3,!0)}get lastMessage(){return this.conversation.lastMessage}set lastMessage(t){this.conversation.lastMessage=t}get isMentionMe(){return this.conversation.isMentionMe}get remoteExtra(){return this.conversation.remoteExtra}set isMentionMe(t){this.conversation.isMentionMe=t}get reminders(){return this.conversation.reminders}get simpleReminders(){return this.conversation.simpleReminders}reloadIsMentionMe(){return this.conversation.reloadIsMentionMe()}get extra(){return this.conversation.extra||(this.conversation.extra={}),this.conversation.extra}isEqual(t){return this.conversation.isEqual(t.conversation)}}function Be(h,t){var f=new Date,v=new Date(h),T=f.getFullYear(),I=f.getMonth()+1,$=f.getDate(),D=v.getFullYear(),_=v.getMonth()+1,i=v.getDate(),p="",C=t?" "+H(v,"hh:mm"):"";if(T===D){var L=f.getTime(),s=h,c=L-s;if(I===_&&$===i)c<60*1e3?p="刚刚":p=H(v,"hh:mm");else{var o=new Date;o.setDate(o.getDate()-1);var d=new Date;if(d.setDate(d.getDate()-2),_===o.getMonth()+1&&i===o.getDate())p="昨天"+C;else if(_===d.getMonth()+1&&i===d.getDate())p="前天"+C;else{var m=c/36e5;if(m<=7*24){var u=new Array(7);u[0]="星期日",u[1]="星期一",u[2]="星期二",u[3]="星期三",u[4]="星期四",u[5]="星期五",u[6]="星期六";var S=u[v.getDay()];p=S+C}else p=H(v,"yyyy/M/d")+C}}}else p=H(v,"yyyy/M/d")+C;return p}var H=function(h,t){var f={"M+":h.getMonth()+1,"d+":h.getDate(),"h+":h.getHours(),"m+":h.getMinutes(),"s+":h.getSeconds(),"q+":Math.floor((h.getMonth()+3)/3),S:h.getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(h.getFullYear()+"").substr(4-RegExp.$1.length)));for(var v in f)new RegExp("("+v+")").test(t)&&(t=t.replace(RegExp.$1,RegExp.$1.length===1?f[v]:("00"+f[v]).substr((""+f[v]).length)));return t};const Pe={class:"conversations"},Ke=["onClick"],Ve={class:"item-content"},Ge={class:"left"},Oe={key:0,class:"avatar",style:{width:"48px",height:"48px"}},je=["src"],ze={key:1,class:"avatar",style:{width:"48px",height:"48px"}},Je={class:"right"},Ye={class:"right-item1"},Qe={class:"title"},Xe={class:"time"},Ze={class:"right-item2"},We={class:"last-msg"},et={key:0,className:"reddot"},tt=re({__name:"index",props:{onSelectChannel:{type:Function}},setup(h){const t=M(),f=M(),v=h,T=async s=>{if(console.log("connectStatusListener",s),s===he.Connected){const c=await r.shared().conversationManager.sync();c&&c.length>0&&(t.value=i(c.map(o=>new Y(o))))}},I=s=>{console.log("收到CMD：",s);const c=s.content;if(c.cmd===Te.CMDTypeClearUnread){const o=new P(c.param.channelID,c.param.channelType);_(o)}},$=(s,c)=>{var o,d,m;if(console.log("conversationListener",s,c),c===U.add)t.value=[new Y(s),...t.value||[]];else if(c===U.update){const u=(o=t.value)==null?void 0:o.findIndex(S=>S.channel.channelID===s.channel.channelID&&S.channel.channelType===s.channel.channelType);u!==void 0&&u>=0&&(t.value[u]=new Y(s),t.value=i())}else if(c===U.remove){const u=(d=t.value)==null?void 0:d.findIndex(S=>S.channel.channelID===s.channel.channelID&&S.channel.channelType===s.channel.channelType);u&&u>=0&&((m=t.value)==null||m.splice(u,1))}},D=s=>{t.value=[...t.value||[]]},_=s=>{const c=r.shared().conversationManager.findConversation(s);c&&(c.unread=0,r.shared().conversationManager.notifyConversationListeners(c,U.update))};ce(async()=>{r.shared().connectManager.addConnectStatusListener(T),r.shared().conversationManager.addConversationListener($),r.shared().chatManager.addCMDListener(I),r.shared().channelManager.addListener(D)}),ie(()=>{r.shared().conversationManager.removeConversationListener($),r.shared().connectManager.removeConnectStatusListener(T),r.shared().chatManager.removeCMDListener(I),r.shared().channelManager.removeListener(D)});const i=s=>{let c=s;return c||(c=t.value),!c||c.length<=0?[]:c.sort((d,m)=>{var E,q;let u=d.timestamp,S=m.timestamp;return((E=d.extra)==null?void 0:E.top)===1&&(u+=1e12),((q=m.extra)==null?void 0:q.top)===1&&(S+=1e12),S-u})},p=s=>{f.value=s,v&&v.onSelectChannel(s),b.shared.clearUnread(s),_(s)},C=s=>f.value&&f.value.isEqual(s.channel)?"conversation-item selected":"conversation-item",L=s=>{r.shared().channelManager.getChannelInfo(s)||r.shared().channelManager.fetchChannelInfo(s)};return(s,c)=>(x(),y("div",Pe,[(x(!0),y(F,null,ue(t.value,o=>{var d,m,u;return x(),y("div",{class:we(C(o)),onClick:()=>{p(o.channel)}},[Q(k(L(o.channel))+" ",1),n("div",Ve,[n("div",Ge,[o.channel.channelType===X(B)?(x(),y("div",Oe,[n("img",{src:(d=o.channelInfo)==null?void 0:d.logo,style:{width:"48px",height:"48px"}},null,8,je)])):(x(),y("div",ze,k((m=o.channelInfo)==null?void 0:m.title),1))]),n("div",Je,[n("div",Ye,[n("div",Qe,k(o.channel.channelID),1),n("div",Xe,k(o.timestampString),1)]),n("div",Ze,[n("div",We,k((u=o.lastMessage)==null?void 0:u.content.conversationDigest),1),o.unread>0?(x(),y("div",et,k(o.unread),1)):A("",!0)])])])],10,Ke)}),256))]))}});const nt=de(tt,[["__scopeId","data-v-efe3aebe"]]),st=h=>(Ae("data-v-b5543bfe"),h=h(),Ue(),h),at={class:"chat"},ot={class:"header"},lt=st(()=>n("div",{class:"left"},[n("button",null,"聊天列表")],-1)),rt={class:"center"},ct={class:"right",style:{display:"flex","align-items":"center"}},it={class:"content"},ut={class:"conversation-box"},ht={class:"message-box"},dt=["id"],vt={key:0,class:"status"},gt={class:"bubble right"},ft=["innerHTML"],_t={class:"avatar"},mt=["src"],pt=["id"],Mt={class:"avatar"},Ct=["src"],St={class:"bubble"},xt=["innerHTML"],yt={class:"footer"},It=["placeholder"],Dt={class:"switch"},wt={class:"item"},Tt=["checked"],Lt={class:"item"},kt=["checked"],$t=["placeholder"],bt=re({__name:"Admin",setup(h){const t=Le(),f=M(null),v=M(!1),T=M(""),I=M("");let $=0;const D=M(""),_=M(!0),i=M(new P("",0)),p=M("请输入对方登录名"),C=M(!1),L=M(!1),s=M(!1),c=M("请输入消息"),o=M(),d=M(new Array);let m=t.currentRoute.value.query.uid||void 0,u=t.currentRoute.value.query.token||"token111";T.value=`${m||""}(未连接)`;let S,E,q;ce(()=>{(!b.shared.config.apiURL||b.shared.config.apiURL==="")&&r.shared().connectManager.disconnect(),b.shared.post(ke.BASE_URL+"/api/getSocketAddress",{chat_id:t.currentRoute.value.query.chat_id,language:t.currentRoute.value.query.language}).then(e=>{if(console.log("接口请求结果",e),e.code!==200)return alert(e.msg);let a="wss://"+e.data.wsAddress;(!a||a==="")&&(a=e.ws_addr),ve(a,e.data)}).catch(e=>{console.log(e)})});const ve=(e,a)=>{const l=r.shared().config;m=a.chatInfo.uid,u=a.chatInfo.token,D.value=a.customer.uid.toString(),m&&u&&(l.uid=m,l.token=u),l.addr=e,r.shared().config=l,S=g=>{g==he.Connected?T.value=`${m||""}(连接成功)`:T.value=`${m||""}(断开)`},r.shared().connectManager.addConnectStatusListener(S),E=g=>{if(i.value.isEqual(g.channel)){if(g.streamOn){let w=!1;for(const V of d.value)if(V.streamNo===g.streamNo){let N=V.streams;const R=new He;R.clientMsgNo=g.clientMsgNo,R.streamSeq=g.streamSeq||0,R.content=g.content,N&&N.length>0?N.push(R):N=[R],V.streams=N,w=!0;break}w||d.value.push(g)}else d.value.push(g);K()}},r.shared().chatManager.addMessageListener(E),q=g=>{console.log(g),d.value.forEach(w=>{if(w.clientSeq==g.clientSeq){w.status=g.reasonCode==1?O.Normal:O.Fail;return}})},r.shared().chatManager.addMessageStatusListener(q),r.shared().connect()};ie(()=>{r.shared().connectManager.removeConnectStatusListener(S),r.shared().chatManager.removeMessageListener(E),r.shared().chatManager.removeMessageStatusListener(q),r.shared().disconnect()});const ge=e=>{_.value=e.target.checked,_.value?p.value="请输入对方登录名":p.value="请输入群组ID"},fe=e=>{_.value=!e.target.checked,_.value?p.value="请输入对方登录名":p.value="请输入群组ID"},K=()=>{const e=f.value;e&&oe(function(){e.scrollTop=e.scrollHeight})},Z=async()=>{C.value=!0,L.value=!1;const e=await r.shared().chatManager.syncMessages(i.value,{limit:15,startMessageSeq:0,endMessageSeq:0,pullMode:le.Up});C.value=!1,e&&e.length>0&&e.forEach(a=>{d.value.push(a)}),K()},_e=async()=>{if(d.value.length==0)return;const e=d.value[0];if(e.messageSeq==1){L.value=!0;return}const a=15,l=await r.shared().chatManager.syncMessages(i.value,{limit:a,startMessageSeq:e.messageSeq-1,endMessageSeq:0,pullMode:le.Down});l.length<a&&(L.value=!0),l&&l.length>0&&l.reverse().forEach(g=>{d.value.unshift(g)}),oe(function(){const g=f.value,w=document.getElementById(e.clientMsgNo);w&&(g.scrollTop=w.offsetTop)})},W=()=>{v.value=!v.value},me=()=>{_.value?i.value=new P(D.value,B):i.value=new P(D.value,z),_.value||b.shared.joinChannel(i.value.channelID,i.value.channelType,r.shared().config.uid||""),r.shared().conversationManager.findConversation(i.value)||r.shared().conversationManager.createEmptyConversation(i.value),v.value=!1,d.value=[],Z()},pe=e=>{i.value=e,D.value=e.channelID,_.value=e.channelType==B,v.value=!1,d.value=[],Z()},ee=()=>{(!I.value||I.value.trim()==="")&&($++,I.value=`${$}`);const e=qe.fromUint8(0);if(i.value&&i.value.channelID!=""){var a;o.value&&o.value!==""&&(e.streamNo=o.value),a=new j(I.value),a.text='<div class="message-bubble">'+a.text+"</div>",console.log("消息内容是: ",a),r.shared().chatManager.send(a,i.value,e),I.value=""}else v.value=!0;K()},Me=async()=>{if(!i.value||i.value.channelID===""){v.value=!0;return}const e=!s.value;if(e){const a=JSON.stringify({type:Ne.text,content:"我是流消息"}),l=await b.shared.messageStreamStart({header:{red_dot:1},from_uid:r.shared().config.uid||"",channel_id:i.value.channelID,channel_type:i.value.channelType,payload:Re.Buffer.from(a).toString("base64")}).catch(g=>{alert(g.msg)});l&&Ce(l.stream_no)}else Se();s.value=e,c.value=e?"现在开始你输入的消息是流式消息，多次输入试试。":"请输入消息"},Ce=e=>{o.value=e},Se=async()=>{await b.shared.messageStreamEnd({stream_no:o.value||"",channel_id:D.value,channel_type:_.value?B:z}),o.value=void 0},te=e=>{if(e instanceof Fe){const a=e.streams;let l="";if(e.content instanceof j&&(l=e.content.text||""),a&&a.length>0){for(const g of a)if(g.content instanceof j){const w=g.content;l=l+(w.text||"")}}return l}return"未知消息"},xe=e=>{const a=e.target.scrollTop;if(e.target.scrollHeight-(a+e.target.clientHeight),a<=250){if(C.value||L.value){console.log("不允许下拉","pulldowning",C.value,"pulldownFinished",L.value);return}console.log("下拉"),C.value=!0,_e().then(()=>{C.value=!1}).catch(()=>{C.value=!1})}},ye=()=>{ee()};return(e,a)=>(x(),y(F,null,[n("div",at,[n("div",ot,[lt,n("div",rt,k(T.value),1),n("div",ct,[n("button",{onClick:W},k(i.value.channelID.length==0?"与谁会话？":`${i.value.channelType==X(z)?"群":"单聊"}${i.value.channelID}`),1)])]),n("div",it,[n("div",ut,[ne(nt,{onSelectChannel:pe})]),n("div",ht,[n("div",{class:"message-list",onScroll:xe,ref_key:"chatRef",ref:f},[(x(!0),y(F,null,ue(d.value,l=>(x(),y(F,null,[l.send?(x(),y("div",{key:0,class:"message right",id:l.clientMsgNo},[l.status!=X(O).Normal?(x(),y("div",vt,"发送中")):A("",!0),n("div",gt,[n("div",{class:"text",innerHTML:te(l)},null,8,ft)]),n("div",_t,[n("img",{src:`https://api.multiavatar.com/${l.fromUID}.png`,style:{width:"40px",height:"40px"}},null,8,mt)])],8,dt)):A("",!0),l.send?A("",!0):(x(),y("div",{key:1,class:"message",id:l.clientMsgNo},[n("div",Mt,[n("img",{src:`https://api.multiavatar.com/${l.fromUID}.png`,style:{width:"40px",height:"40px"}},null,8,Ct)]),n("div",St,[n("div",{class:"text",innerHTML:te(l)},null,8,xt)])],8,pt))],64))),256))],544),n("div",yt,[se(n("input",{placeholder:c.value,"onUpdate:modelValue":a[0]||(a[0]=l=>I.value=l),style:{height:"40px"},onKeydown:$e(ye,["enter"])},null,40,It),[[ae,I.value]]),n("button",{class:"message-stream",onClick:Me},k(s.value?"停止流消息":"开启流消息"),1),n("button",{onClick:ee},"发送")])])])]),ne(Ee,{name:"fade"},{default:be(()=>[v.value?(x(),y("div",{key:0,class:"setting",onClick:W},[n("div",{class:"setting-content",onClick:a[2]||(a[2]=J(()=>{},["stop"]))},[n("div",Dt,[n("div",wt,[n("input",{type:"radio",onClick:J(ge,["stop"]),checked:_.value},null,8,Tt),Q("单聊 ")]),n("div",Lt,[n("input",{type:"radio",onClick:J(fe,["stop"]),checked:!_.value},null,8,kt),Q("群聊 ")])]),se(n("input",{placeholder:p.value,class:"to","onUpdate:modelValue":a[1]||(a[1]=l=>D.value=l)},null,8,$t),[[ae,D.value]]),n("button",{class:"ok",onClick:me},"确定")])])):A("",!0)]),_:1})],64))}});const Rt=de(bt,[["__scopeId","data-v-b5543bfe"]]);export{Rt as default};
