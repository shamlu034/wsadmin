var we=Object.defineProperty;var De=(h,s,l)=>s in h?we(h,s,{enumerable:!0,configurable:!0,writable:!0,value:l}):h[s]=l;var G=(h,s,l)=>(De(h,typeof s!="symbol"?s+"":s,l),l);import{d as le,r as m,o as re,W as r,a as ce,b as y,c as S,F as B,e as ie,C as ue,f as Te,g as K,h as F,n as ke,i as P,t as D,j as t,u as Q,k as H,l as U,A as b,_ as he,m as Le,p as z,q as te,w as ne,v as se,s as $e,x as be,T as Ee,M as O,y as ae,S as qe,z as j,B as Ne,D as Re,E as J,G as Ue,H as Fe,I as Ae,P as oe,J as Be}from"./index-9c8d78fe.js";class Y{constructor(s){G(this,"conversation");G(this,"avatarHashTag");this.conversation=s}get channel(){return this.conversation.channel}get channelInfo(){return this.conversation.channelInfo}get unread(){return this.conversation.unread}get timestamp(){return this.conversation.timestamp}set timestamp(s){this.conversation.timestamp=s}get timestampString(){return Ke(this.timestamp*1e3,!0)}get lastMessage(){return this.conversation.lastMessage}set lastMessage(s){this.conversation.lastMessage=s}get isMentionMe(){return this.conversation.isMentionMe}get remoteExtra(){return this.conversation.remoteExtra}set isMentionMe(s){this.conversation.isMentionMe=s}get reminders(){return this.conversation.reminders}get simpleReminders(){return this.conversation.simpleReminders}reloadIsMentionMe(){return this.conversation.reloadIsMentionMe()}get extra(){return this.conversation.extra||(this.conversation.extra={}),this.conversation.extra}isEqual(s){return this.conversation.isEqual(s.conversation)}}function Ke(h,s){var l=new Date,d=new Date(h),T=l.getFullYear(),I=l.getMonth()+1,$=l.getDate(),w=d.getFullYear(),f=d.getMonth()+1,u=d.getDate(),p="",M=s?" "+A(d,"hh:mm"):"";if(T===w){var k=l.getTime(),a=h,i=k-a;if(I===f&&$===u)i<60*1e3?p="刚刚":p=A(d,"hh:mm");else{var c=new Date;c.setDate(c.getDate()-1);var v=new Date;if(v.setDate(v.getDate()-2),f===c.getMonth()+1&&u===c.getDate())p="昨天"+M;else if(f===v.getMonth()+1&&u===v.getDate())p="前天"+M;else{var _=i/36e5;if(_<=7*24){var g=new Array(7);g[0]="星期日",g[1]="星期一",g[2]="星期二",g[3]="星期三",g[4]="星期四",g[5]="星期五",g[6]="星期六";var x=g[d.getDay()];p=x+M}else p=A(d,"yyyy/M/d")+M}}}else p=A(d,"yyyy/M/d")+M;return p}var A=function(h,s){var l={"M+":h.getMonth()+1,"d+":h.getDate(),"h+":h.getHours(),"m+":h.getMinutes(),"s+":h.getSeconds(),"q+":Math.floor((h.getMonth()+3)/3),S:h.getMilliseconds()};/(y+)/.test(s)&&(s=s.replace(RegExp.$1,(h.getFullYear()+"").substr(4-RegExp.$1.length)));for(var d in l)new RegExp("("+d+")").test(s)&&(s=s.replace(RegExp.$1,RegExp.$1.length===1?l[d]:("00"+l[d]).substr((""+l[d]).length)));return s};const He={class:"conversations"},Pe=["onClick"],Ve={class:"item-content"},Ge={class:"left"},ze={key:0,class:"avatar",style:{width:"48px",height:"48px"}},Oe=["src"],je={key:1,class:"avatar",style:{width:"48px",height:"48px"}},Je={class:"right"},Ye={class:"right-item1"},Qe={class:"title"},Xe={class:"time"},Ze={class:"right-item2"},We={class:"last-msg"},et={key:0,className:"reddot"},tt=le({__name:"index",props:{onSelectChannel:{type:Function}},setup(h){const s=h,l=m(),d=m(),T=async a=>{if(console.log("connectStatusListener",a),a===ue.Connected){const i=await r.shared().conversationManager.sync();i&&i.length>0&&(l.value=u(i.map(c=>new Y(c))))}},I=a=>{console.log("收到CMD：",a);const i=a.content;if(i.cmd===Te.CMDTypeClearUnread){const c=new K(i.param.channelID,i.param.channelType);f(c)}},$=(a,i)=>{var c,v,_;if(console.log("conversationListener",a,i),i===F.add)l.value=[new Y(a),...l.value||[]];else if(i===F.update){const g=(c=l.value)==null?void 0:c.findIndex(x=>x.channel.channelID===a.channel.channelID&&x.channel.channelType===a.channel.channelType);g!==void 0&&g>=0&&(l.value[g]=new Y(a),l.value=u())}else if(i===F.remove){const g=(v=l.value)==null?void 0:v.findIndex(x=>x.channel.channelID===a.channel.channelID&&x.channel.channelType===a.channel.channelType);g&&g>=0&&((_=l.value)==null||_.splice(g,1))}},w=a=>{l.value=[...l.value||[]]},f=a=>{const i=r.shared().conversationManager.findConversation(a);i&&(i.unread=0,r.shared().conversationManager.notifyConversationListeners(i,F.update))};re(async()=>{r.shared().connectManager.addConnectStatusListener(T),r.shared().conversationManager.addConversationListener($),r.shared().chatManager.addCMDListener(I),r.shared().channelManager.addListener(w)}),ce(()=>{r.shared().conversationManager.removeConversationListener($),r.shared().connectManager.removeConnectStatusListener(T),r.shared().chatManager.removeCMDListener(I),r.shared().channelManager.removeListener(w)});const u=a=>{let i=a;return i||(i=l.value),!i||i.length<=0?[]:i.sort((v,_)=>{var E,q;let g=v.timestamp,x=_.timestamp;return((E=v.extra)==null?void 0:E.top)===1&&(g+=1e12),((q=_.extra)==null?void 0:q.top)===1&&(x+=1e12),x-g})},p=a=>{d.value=a,s&&s.onSelectChannel(a),b.shared.clearUnread(a),f(a)},M=a=>d.value&&d.value.isEqual(a.channel)?"conversation-item selected":"conversation-item",k=a=>{r.shared().channelManager.getChannelInfo(a)||r.shared().channelManager.fetchChannelInfo(a)};return(a,i)=>(y(),S("div",He,[(y(!0),S(B,null,ie(l.value,c=>{var v,_,g;return y(),S("div",{class:ke(M(c)),onClick:()=>{p(c.channel)}},[P(D(k(c.channel))+" ",1),t("div",Ve,[t("div",Ge,[c.channel.channelType===Q(H)?(y(),S("div",ze,[t("img",{src:(v=c.channelInfo)==null?void 0:v.logo,style:{width:"48px",height:"48px"}},null,8,Oe)])):(y(),S("div",je,D((_=c.channelInfo)==null?void 0:_.title),1))]),t("div",Je,[t("div",Ye,[t("div",Qe,D(c.channel.channelID),1),t("div",Xe,D(c.timestampString),1)]),t("div",Ze,[t("div",We,D((g=c.lastMessage)==null?void 0:g.content.conversationDigest),1),c.unread>0?(y(),S("div",et,D(c.unread),1)):U("",!0)])])])],10,Pe)}),256))]))}});const nt=he(tt,[["__scopeId","data-v-a98496d7"]]),de=h=>(Ue("data-v-0aed8735"),h=h(),Fe(),h),st={class:"chat"},at={class:"header"},ot=de(()=>t("button",null,"聊天列表",-1)),lt={class:"center"},rt={class:"right",style:{display:"flex","align-items":"center"}},ct=de(()=>t("a",{style:{"margin-right":"40px",display:"flex","align-items":"center","font-size":"12px"},href:"https://github.com/WuKongIM/WuKongIM","aria-label":"github",target:"_blank",rel:"noopener","data-v-7bc22406":"","data-v-36371990":""},[t("svg",{role:"img",width:"32px",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[t("title",null,"GitHub"),t("path",{d:"M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"})]),P("    吴彦祖，点个Star呗 ")],-1)),it={class:"content"},ut={class:"conversation-box"},ht={class:"message-box"},dt=["id"],vt={key:0,class:"status"},gt={class:"bubble right"},ft={class:"text"},pt={class:"avatar"},_t=["src"],mt=["id"],Mt={class:"avatar"},Ct=["src"],xt={class:"bubble"},yt={class:"text"},St={class:"footer"},It=["placeholder","onKeydown"],wt={class:"switch"},Dt={class:"item"},Tt=["onClick","checked"],kt={class:"item"},Lt=["onClick","checked"],$t=["placeholder"],bt=le({__name:"Chat",setup(h){const s=Le(),l=m(null),d=m(!1),T=m(""),I=m("");let $=0;const w=m(""),f=m(!0),u=m(new K("",0)),p=m("请输入对方登录名"),M=m(!1),k=m(!1),a=m(!1),i=m("请输入消息"),c=m(),v=m(new Array),_=s.currentRoute.value.query.uid||void 0,g=s.currentRoute.value.query.token||"token111";T.value=`${_||""}(未连接)`;let x,E,q;re(()=>{(!b.shared.config.apiURL||b.shared.config.apiURL==="")&&(r.shared().connectManager.disconnect(),s.push({path:"/"})),b.shared.get("/route",{param:{uid:s.currentRoute.value.query.uid}}).then(e=>{console.log(e);let o=e.wss_addr;(!o||o==="")&&(o=e.ws_addr),ve(o)}).catch(e=>{console.log(e)})});const ve=e=>{const o=r.shared().config;_&&g&&(o.uid=_,o.token=g),o.addr=e,r.shared().config=o,x=n=>{n==ue.Connected?T.value=`${_||""}(连接成功)`:T.value=`${_||""}(断开)`},r.shared().connectManager.addConnectStatusListener(x),E=n=>{if(u.value.isEqual(n.channel)){if(n.streamOn){let C=!1;for(const L of v.value)if(L.streamNo===n.streamNo){let N=L.streams;const R=new Ae;R.clientMsgNo=n.clientMsgNo,R.streamSeq=n.streamSeq||0,R.content=n.content,N&&N.length>0?N.push(R):N=[R],L.streams=N,C=!0;break}C||v.value.push(n)}else v.value.push(n);V()}},r.shared().chatManager.addMessageListener(E),q=n=>{console.log(n),v.value.forEach(C=>{if(C.clientSeq==n.clientSeq){C.status=n.reasonCode==1?O.Normal:O.Fail;return}})},r.shared().chatManager.addMessageStatusListener(q),r.shared().connect()};ce(()=>{r.shared().connectManager.removeConnectStatusListener(x),r.shared().chatManager.removeMessageListener(E),r.shared().chatManager.removeMessageStatusListener(q),r.shared().disconnect()});const ge=e=>{f.value=e.target.checked,f.value?p.value="请输入对方登录名":p.value="请输入群组ID"},fe=e=>{f.value=!e.target.checked,f.value?p.value="请输入对方登录名":p.value="请输入群组ID"},V=()=>{const e=l.value;e&&ae(function(){e.scrollTop=e.scrollHeight})},X=async()=>{M.value=!0,k.value=!1;const e=await r.shared().chatManager.syncMessages(u.value,{limit:15,startMessageSeq:0,endMessageSeq:0,pullMode:oe.Up});M.value=!1,e&&e.length>0&&e.forEach(o=>{v.value.push(o)}),V()},pe=async()=>{if(v.value.length==0)return;const e=v.value[0];if(e.messageSeq==1){k.value=!0;return}const o=15,n=await r.shared().chatManager.syncMessages(u.value,{limit:o,startMessageSeq:e.messageSeq-1,endMessageSeq:0,pullMode:oe.Down});n.length<o&&(k.value=!0),n&&n.length>0&&n.reverse().forEach(C=>{v.value.unshift(C)}),ae(function(){const C=l.value,L=document.getElementById(e.clientMsgNo);L&&(C.scrollTop=L.offsetTop)})},Z=()=>{d.value=!d.value},_e=()=>{f.value?u.value=new K(w.value,H):u.value=new K(w.value,z),f.value||b.shared.joinChannel(u.value.channelID,u.value.channelType,r.shared().config.uid||""),r.shared().conversationManager.findConversation(u.value)||r.shared().conversationManager.createEmptyConversation(u.value),d.value=!1,v.value=[],X()},me=e=>{u.value=e,w.value=e.channelID,f.value=e.channelType==H,d.value=!1,v.value=[],X()},W=()=>{(!I.value||I.value.trim()==="")&&($++,I.value=`${$}`);const e=qe.fromUint8(0);if(u.value&&u.value.channelID!=""){var o;c.value&&c.value!==""&&(e.streamNo=c.value),o=new j(I.value),r.shared().chatManager.send(o,u.value,e),I.value=""}else d.value=!0;V()},Me=async()=>{if(!u.value||u.value.channelID===""){d.value=!0;return}const e=!a.value;if(e){const o=JSON.stringify({type:Ne.text,content:"我是流消息"}),n=await b.shared.messageStreamStart({header:{red_dot:1},from_uid:r.shared().config.uid||"",channel_id:u.value.channelID,channel_type:u.value.channelType,payload:Re.Buffer.from(o).toString("base64")}).catch(C=>{alert(C.msg)});n&&Ce(n.stream_no)}else xe();a.value=e,i.value=e?"现在开始你输入的消息是流式消息，多次输入试试。":"请输入消息"},Ce=e=>{c.value=e},xe=async()=>{await b.shared.messageStreamEnd({stream_no:c.value||"",channel_id:w.value,channel_type:f.value?H:z}),c.value=void 0},ye=()=>{r.shared().connectManager.disconnect(),s.push({path:"/"})},ee=e=>{if(e instanceof Be){const o=e.streams;let n="";if(e.content instanceof j&&(n=e.content.text||""),o&&o.length>0){for(const C of o)if(C.content instanceof j){const L=C.content;n=n+(L.text||"")}}return n}return"未知消息"},Se=e=>{const o=e.target.scrollTop;if(e.target.scrollHeight-(o+e.target.clientHeight),o<=250){if(M.value||k.value){console.log("不允许下拉","pulldowning",M.value,"pulldownFinished",k.value);return}console.log("下拉"),M.value=!0,pe().then(()=>{M.value=!1}).catch(()=>{M.value=!1})}},Ie=()=>{W()};return(e,o)=>(y(),S(B,null,[t("div",st,[t("div",at,[t("div",{class:"left"},[t("button",{onClick:ye},"退出"),ot]),t("div",lt,D(T.value),1),t("div",rt,[ct,t("button",{onClick:Z},D(u.value.channelID.length==0?"与谁会话？":`${u.value.channelType==Q(z)?"群":"单聊"}${u.value.channelID}`),1)])]),t("div",it,[t("div",ut,[te(nt,{onSelectChannel:me})]),t("div",ht,[t("div",{class:"message-list",onScroll:Se,ref_key:"chatRef",ref:l},[(y(!0),S(B,null,ie(v.value,n=>(y(),S(B,null,[n.send?(y(),S("div",{key:0,class:"message right",id:n.clientMsgNo},[n.status!=Q(O).Normal?(y(),S("div",vt,"发送中")):U("",!0),t("div",gt,[t("div",ft,D(ee(n)),1)]),t("div",pt,[t("img",{src:`https://api.multiavatar.com/${n.fromUID}.png`,style:{width:"40px",height:"40px"}},null,8,_t)])],8,dt)):U("",!0),n.send?U("",!0):(y(),S("div",{key:1,class:"message",id:n.clientMsgNo},[t("div",Mt,[t("img",{src:`https://api.multiavatar.com/${n.fromUID}.png`,style:{width:"40px",height:"40px"}},null,8,Ct)]),t("div",xt,[t("div",yt,D(ee(n)),1)])],8,mt))],64))),256))],544),t("div",St,[ne(t("input",{placeholder:i.value,"onUpdate:modelValue":o[0]||(o[0]=n=>I.value=n),style:{height:"40px"},onKeydown:$e(Ie,["enter"])},null,40,It),[[se,I.value]]),t("button",{class:"message-stream",onClick:Me},D(a.value?"停止流消息":"开启流消息"),1),t("button",{onClick:W},"发送")])])])]),te(Ee,{name:"fade"},{default:be(()=>[d.value?(y(),S("div",{key:0,class:"setting",onClick:Z},[t("div",{class:"setting-content",onClick:o[2]||(o[2]=J(()=>{},["stop"]))},[t("div",wt,[t("div",Dt,[t("input",{type:"radio",onClick:J(ge,["stop"]),checked:f.value},null,8,Tt),P("单聊 ")]),t("div",kt,[t("input",{type:"radio",onClick:J(fe,["stop"]),checked:!f.value},null,8,Lt),P("群聊 ")])]),ne(t("input",{placeholder:p.value,class:"to","onUpdate:modelValue":o[1]||(o[1]=n=>w.value=n)},null,8,$t),[[se,w.value]]),t("button",{class:"ok",onClick:_e},"确定")])])):U("",!0)]),_:1})],64))}});const Nt=he(bt,[["__scopeId","data-v-0aed8735"]]);export{Nt as default};
